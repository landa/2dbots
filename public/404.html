<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>2dBots &mdash; Introduction</title>

    <!-- update the version number as needed -->
    <script defer src="/__/firebase/7.13.1/firebase-app.js"></script>
    <!-- include only the Firebase features as you need -->
    <script defer src="/__/firebase/7.13.1/firebase-auth.js"></script>
    <script defer src="/__/firebase/7.13.1/firebase-database.js"></script>
    <script defer src="/__/firebase/7.13.1/firebase-messaging.js"></script>
    <script defer src="/__/firebase/7.13.1/firebase-storage.js"></script>
    <script defer src="/__/firebase/7.13.1/firebase-analytics.js"></script>
    <!-- initialize the SDK after all desired features are loaded -->
    <script defer src="/__/firebase/init.js"></script>

    <script defer src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script defer src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/p5@1.0.0/lib/p5.js"></script>

    <script defer src="js/codemirror.js"></script>
    <script defer src="js/javascript.js"></script>

    <script defer src="js/constants.js"></script>
    <script defer src="js/utils.js"></script>
    <script defer src="js/robot.js"></script>
    <script defer src="js/simulation.js"></script>

    <link rel="apple-touch-icon" sizes="57x57" href="img/favicon/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="img/favicon/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="img/favicon/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="img/favicon/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="img/favicon/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="img/favicon/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="img/favicon/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="img/favicon/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="img/favicon/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="img/favicon/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="img/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="img/favicon/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="img/favicon/favicon-16x16.png">
    <link rel="manifest" href="img/favicon/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
    <meta name="theme-color" content="#222222">

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Baloo+Paaji+2&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/font-awesome.min.css">
    <link rel="stylesheet" href="css/codemirror.css">
    <link rel="stylesheet" href="css/theme/ambiance.css">
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/challenge.css">
  </head>
  <body>
    <header>
      <div class="navbar navbar-dark bg-dark">
        <div class="container d-flex justify-content-between pl-3 pr-3">
          <a href="/" class="navbar-brand d-flex align-items-center">
            <i class="fas fa-robot mr-3"></i>
            <strong>2dBots &mdash; Introduction</strong>
          </a>
        </div>
      </div>
    </header>

    <main role="main">

      <div class="container instructions">
        <section class="jumbotron row justify-content-center px-xl-5 bg-dark">
          <div class="col-lg-12 col-xl-6">
            <h4>Page Not Found</h4>
            <p>
              Sorry. Try to pathfind to a page that actually exists!
            <p>
          </div>
          <div class="col-lg-12 demo-container col-xl-6">
            <div class="card-body h-100 p-0">
              <div class="row h-100">
                <div class="simulation-container col-md-12 col-lg-12 px-0"></div>
                <div class="grid-container">
                [
                  [
                    [E, E, E, E, E, E, E, E],
                    [E, W, W, W, W, W, W, E],
                    [E, W, W, W, W, W, W, E],
                    [E, W, W, W, W, W, W, E],
                    [E, E, E, E, E, E, E, E],
                  ]
                ]
                </div>
                <div class="simulation-robots">
                  <div class="simulation-robot">
                    <div class="simulation-robot-code">
                      class LostRobot extends BumperBot {
                        *produceNextMove() {
                          let isTurningRight = true;
                          while (true) {
                            while (this.canMoveForward()) {
                              if (Math.random() < 0.05) {
                                yield this.turnLeft;
                                yield this.turnLeft;
                                isTurningRight = !isTurningRight;
                                for (let ii = 0; ii < 20; ++ii) {
                                  yield this.wait;
                                }
                              }
                              yield this.moveForward();
                              for (let ii = 0; ii < 20; ++ii) {
                                yield this.wait;
                              }
                            }
                            if (isTurningRight) {
                              yield this.turnRight;
                            } else {
                              yield this.turnLeft;
                            }
                          }
                        }
                      }
                    </div>
                    <div class="simulation-robot-x">0</div>
                    <div class="simulation-robot-y">0</div>
                    <div class="simulation-robot-d">1</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </main>

    <footer class="mt-5 pt-3 pb-5 bg-dark text-muted">
      <div class="container">
        <p class="float-right">
          <a href="#">Back to top</a>
        </p>
        <p>&copy; 2dbots.com</p>
      </div>
    </footer>

    <script>
      document.addEventListener('DOMContentLoaded', function() {

        let examples = $('.example-container textarea');
        for (let ii = 0; ii < examples.length; ++ii) {
          let example = examples[ii];
          CodeMirror.fromTextArea(example, {
            lineNumbers: true,
            viewportMargin: Infinity,
            theme: 'ambiance',
            mode: 'javascript',
            tabSize: 2,
            indentWithTabs: false,
            readOnly: true,
          });
        }

        let hintModalBody = $('#hints-modal .modal-body');

        let demos = $('.demo-container');
        for (let ii = 0; ii < demos.length; ++ii) {
          let demo = demos[ii];
          let simulationContainer = $(demo).find('.simulation-container');
          let gridContainer = $(demo).find('.grid-container');
          let robotsContainer = $(demo).find('.simulation-robots');

          let grids = eval(gridContainer.text());
          let grid = grids[0];

          let simulation = new Simulation(grid, simulationContainer.get(0));

          let robots = $(robotsContainer).children();
          for (let jj = 0; jj < robots.length; ++jj) {
            let robot = eval('(' + $(robots[jj]).find('.simulation-robot-code').text() + ')');
            let x = eval('(' + $(robots[jj]).find('.simulation-robot-x').text() + ')');
            let y = eval('(' + $(robots[jj]).find('.simulation-robot-y').text() + ')');
            let d = eval('(' + $(robots[jj]).find('.simulation-robot-d').text() + ')');
            simulation.addRobot(new robot(simulation), x, y, d);
          }

          new p5(simulation.p5.bind(simulation), simulationContainer.get(0));

          $(simulationContainer).data('simulation', simulation);

          $(window).on('resize', function(event) {
            simulation.windowResized.bind(simulation)();
          });
        }

        // Bumper Bot
        let container = $('.robot-introduction-bumperbot');
        let simulation = $(container).find('.simulation-container').data('simulation');
        let moveForwardButton = $(container).find('.button-move-forward');
        let turnRightButton = $(container).find('.button-turn-right');
        let turnLeftButton = $(container).find('.button-turn-left');
        let senseForwardButton = $(container).find('.button-sense-forward');
        let robot = new Robot(simulation);
        simulation.addRobot(robot, 0, 2, 0);
        $(moveForwardButton).click(function(event) {
          simulation.moveForwardRobot(robot.robot_idx);
        });
        $(turnRightButton).click(function(event) {
          simulation.turnRightRobot(robot.robot_idx);
        });
        $(turnLeftButton).click(function(event) {
          simulation.turnLeftRobot(robot.robot_idx);
        });
        $(senseForwardButton).click(function(event) {
          let message = simulation.canMoveForwardRobot(robot.robot_idx) ? "True" : "False";
          $(senseForwardButton).popover('dispose');
          $(senseForwardButton).popover({
            content: message,
            placement: 'bottom'
          });
          $(senseForwardButton).popover('show');
          window.setTimeout(function() { $(senseForwardButton).popover('hide'); }, 1000);
        });

        let challenges = $('.challenge-container');
        for (let ii = 0; ii < challenges.length; ++ii) {
          let challenge = challenges[ii];

          let questionContainer = $(challenge).find('.challenge-question-container');
          let editorContainer = $(questionContainer).find('.editor-container');
          let simulationContainer = $(questionContainer).find('.simulation-container');
          let gridContainer = $(questionContainer).find('.grid-container');
          let hints = $(questionContainer).find('.challenge-hints');

          editorContainer.popover({
            content: 'Write your code here',
            trigger: 'manual',
            placement: 'left',
            template: '<div class="popover bounce" role="tooltip"><div class="arrow"></div><h2 class="popover-header"></h2><div class="popover-body"></div></div>'
          });
          $(editorContainer).popover('show');
          $(editorContainer).click(function(event) { $(editorContainer).popover('hide'); });

          var editor = CodeMirror(editorContainer.get(0), {
            lineNumbers: true,
            viewportMargin: Infinity,
            theme: 'ambiance',
            mode: 'javascript',
            tabSize: 2,
            indentWithTabs: false,
            value: `*produceNextMove() {

  // Complete the *produceNextMove function!



}`,
          });

          editorContainer.keydown(function(event) {
            if (event.key == '\'' && (event.ctrlKey || event.metaKey)) {
              runButton.click();
            }
          });

          let grids = eval(gridContainer.text());
          let grid = grids[0];

          let simulation = new Simulation(grid, simulationContainer.get(0));
          simulation.addRobot(new Robot(simulation), 0, 0, 1);
          new p5(simulation.p5.bind(simulation), simulationContainer.get(0));

          // Hack to make the canvas fit into the Bootstrap grid layout
          $(questionContainer).css('padding', '0');

          let runButton = $(questionContainer).find('.run-button');
          let runHint = 'Run your code on the Robot';
          if (navigator.platform.indexOf('Mac') >= 0) {
            runHint += '<br/>Keyboard shortcut:&nbsp;&nbsp;&nbsp;<code>&#8984; + \'</code>';
          } else {
            runHint += '<br/>Keyboard shortcut:&nbsp;&nbsp;&nbsp;<code>Ctrl + \'</code>';
          }
          runButton.popover({
            content: runHint,
            trigger: 'hover',
            placement: 'bottom',
            html: true
          });
          runButton.click(function(event) {
            let code = '(class IntroBot extends BumperBot {\n' + editor.getValue() + '\n})';
            try {
              let RobotDefinition = eval(code);
              let robot = new RobotDefinition(simulation);
              simulation.reset();
              simulation.addRobot(robot, 0, 0, 1);
            } catch (excpt) {
              console.log('Error on line number', excpt.lineNumber, excpt.message);
            }
            setTimeout(function(event) { $(editorContainer).popover('hide'); }, 10000);
          });

          let resetButton = $(questionContainer).find('.reset-button');
          resetButton.popover({
            content: 'Reset the simulation to the beginning',
            trigger: 'hover',
            placement: 'bottom'
          });
          resetButton.click(function(event) {
            simulation.reset();
            simulation.addRobot(new Robot(simulation), 0, 0, 1);
          });

          let hintButton = $(questionContainer).find('.hint-button');
          hintButton.click(function(event) {
            hintModalBody.html('');
            hintModalBody.append(hints.children().clone());
          });

          let mapsDropdown = $(challenge).find('.map-button');
          let mapSelector = $(mapsDropdown).find('.dropdown-menu');
          mapSelector.html('');
          for (let jj = 0; jj < grids.length; ++jj) {
            let el = $('<a class="dropdown-item" href="#"></a>');
            el.text('Map ' + (jj + 1));
            mapSelector.append(el);
          }
          if (grids.length == 1) {
            $(mapsDropdown).hide();
          }

          $(window).on('resize', function(event) {
            // Hack to make the canvas fit into the Bootstrap grid layout
            $(questionContainer).css('padding', '');

            simulation.windowResized.bind(simulation)();

            // Hack to make the canvas fit into the Bootstrap grid layout
            $(questionContainer).css('padding', '0');
          });
        }

      });
    </script>
  </body>
</html>
